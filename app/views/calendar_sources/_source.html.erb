<% sp = CalendarSourcePresenter.new(source, self) %>
<div id="<%= dom_id(source, :card) %>" class="relative rounded-xl border border-slate-800 bg-slate-950/40 p-4">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 pr-40">
      <p class="text-sm font-semibold text-slate-100"><%= sp.name %></p>
      <dl class="mt-2 text-xs text-slate-400">
        <div class="flex gap-2">
          <dt class="font-medium text-slate-500"><%= t("ui.sources.calendar") %></dt>
          <dd><%= sp.calendar_identifier || t("common.states.unknown") %></dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium text-slate-500"><%= t("common.fields.last_synced") %>:</dt>
          <dd><%= sp.last_synced_text %></dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium text-slate-500"><%= t("ui.sources.pending") %></dt>
          <dd><%= sp.pending_count %></dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium text-slate-500"><%= t("ui.sources.next_sync") %></dt>
          <dd><%= sp.next_sync_text %></dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium text-slate-500"><%= t("ui.sources.auto_sync") %></dt>
          <dd><%= sp.sync_frequency_text %></dd>
        </div>
      </dl>
      <%= turbo_stream_from "sync_attempts_source_#{source.id}" %>
      <div class="mt-3">
        <% latest_attempt = (source.sync_attempts || []).max_by(&:created_at) %>
        <%= render "calendar_sources/sync_status", attempt: latest_attempt %>
      </div>
    </div>

    <!-- Status Badges -->
    <div class="flex gap-1 text-xs">
      <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 <%= sp.active_badge_class %>">
        <span class="h-1.5 w-1.5 rounded-full <%= sp.active_dot_class %>"></span>
        <%= sp.active_label %>
      </span>
      <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 <%= sp.auto_sync_badge_class %>">
        <span class="h-1.5 w-1.5 rounded-full <%= sp.auto_sync_dot_class %>"></span>
        <%= source.auto_sync_enabled? ? t("ui.sources.auto_sync_enabled") : t("ui.sources.auto_sync_disabled") %>
      </span>
    </div>
  </div>

  <!-- Action Buttons - Bottom Right -->
  <div class="absolute bottom-4 right-4">
    <% if source.deleted_at.nil? %>
      <div class="flex flex-col gap-2 items-end">
        <!-- Secondary Actions Row (Top) -->
        <div class="flex items-center gap-1">
          <%= button_to t("ui.sources.check_destination"), check_destination_calendar_source_path(source), method: :get, form: { class: "inline", data: { turbo: false } }, class: "cursor-pointer rounded-lg border border-slate-700/50 bg-slate-950/40 px-2 py-1 text-xs text-slate-400 transition hover:border-slate-500 hover:text-slate-200 backdrop-blur-sm" %>
          <%= button_to t("common.actions.archive"),
                calendar_source_path(source),
                method: :delete,
                form: { class: "inline", data: { controller: "confirm", confirm_message_value: t("ui.sources.confirm.archive", name: source.name) } },
                class: "cursor-pointer rounded-lg border border-rose-700/50 bg-rose-950/20 px-2 py-1 text-xs text-rose-400 transition hover:border-rose-500 hover:text-rose-300 backdrop-blur-sm" %>
        </div>

        <!-- Primary Actions Row (Bottom) -->
        <div class="flex items-center gap-1">
          <!-- Sync Group -->
          <div class="flex items-center gap-1 rounded-lg border border-slate-800/50 bg-slate-950/60 px-2 py-1 backdrop-blur-sm">
            <%= button_to t("common.actions.sync"), sync_calendar_source_path(source), method: :post, form: { class: "inline", data: { turbo_stream: true } }, class: "cursor-pointer rounded border-0 bg-transparent px-2 py-1 text-xs text-slate-200 transition hover:bg-slate-800" %>
            <%= button_to t("ui.sources.force_sync"), force_sync_calendar_source_path(source), method: :post, form: { class: "inline", data: { turbo_stream: true, controller: "confirm", confirm_message_value: t("ui.sources.confirm.force_sync", name: source.name) } }, class: "cursor-pointer rounded border-0 bg-transparent px-2 py-1 text-xs text-slate-200 transition hover:bg-slate-800" %>
            <div class="h-4 w-px bg-slate-700"></div>
            <%= button_to(source.auto_sync_enabled? ? "Auto: ON" : "Auto: OFF", toggle_auto_sync_calendar_source_path(source), method: :patch, form: { class: "inline", data: { turbo_stream: true } }, class: "cursor-pointer rounded border-0 bg-transparent px-2 py-1 text-xs transition hover:bg-slate-800 #{source.auto_sync_enabled? ? "text-indigo-300" : "text-slate-400"}") %>
          </div>

          <!-- Management Group -->
          <div class="flex items-center gap-1 rounded-lg border border-slate-800/50 bg-slate-950/60 px-2 py-1 backdrop-blur-sm">
            <%= link_to t("common.actions.edit"), edit_calendar_source_path(source), data: { turbo_frame: "modal" }, class: "cursor-pointer rounded border-0 bg-transparent px-2 py-1 text-xs text-slate-200 transition hover:bg-slate-800" %>
            <%= button_to(source.active? ? t("common.actions.pause") : t("common.actions.resume"), toggle_active_calendar_source_path(source), method: :patch, form: { class: "inline", data: { turbo_stream: true } }, class: "cursor-pointer rounded border-0 bg-transparent px-2 py-1 text-xs text-slate-200 transition hover:bg-slate-800") %>
          </div>
        </div>
      </div>
    <% else %>
      <div class="flex items-center gap-1">
        <%= button_to t("common.actions.unarchive"),
              unarchive_calendar_source_path(source),
              method: :patch,
              form: { class: "inline", data: { turbo_stream: true } },
              class: "cursor-pointer rounded-lg border border-slate-700 bg-slate-950/60 px-2 py-1 text-xs text-slate-200 transition hover:border-slate-500 backdrop-blur-sm" %>
        <%= button_to t("common.actions.purge"),
              purge_calendar_source_path(source),
              method: :delete,
              form: { class: "inline", data: { controller: "confirm", confirm_message_value: t("ui.sources.confirm.purge", name: source.name) } },
              class: "cursor-pointer rounded-lg border border-rose-800 bg-rose-900/40 px-2 py-1 text-xs text-rose-200 transition hover:border-rose-600 backdrop-blur-sm" %>
      </div>
    <% end %>
  </div>
</div>
