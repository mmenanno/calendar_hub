<% sp = CalendarSourcePresenter.new(source, self) %>
<div id="<%= dom_id(source, :card) %>" class="flex items-start justify-between gap-4 rounded-xl border border-slate-800 bg-slate-950/40 p-4">
  <div>
    <p class="text-sm font-semibold text-slate-100"><%= sp.name %></p>
    <p class="text-xs uppercase tracking-wide text-slate-500">ICS Feed</p>
    <dl class="mt-2 text-xs text-slate-400">
      <div class="flex gap-2">
        <dt class="font-medium text-slate-500">Calendar:</dt>
        <dd><%= sp.calendar_identifier %></dd>
      </div>
      <div class="flex gap-2">
        <dt class="font-medium text-slate-500">Last synced:</dt>
        <dd><%= sp.last_synced_text %></dd>
      </div>
      <div class="flex gap-2">
        <dt class="font-medium text-slate-500">Pending:</dt>
        <dd><%= sp.pending_count %></dd>
      </div>
      <div class="flex gap-2">
        <dt class="font-medium text-slate-500">Next eligible sync:</dt>
        <dd><%= sp.next_sync_text %></dd>
      </div>
    </dl>
    <%= turbo_stream_from "sync_attempts_source_#{source.id}" %>
    <div class="mt-3">
      <% latest_attempt = (source.sync_attempts || []).max_by(&:created_at) %>
      <%= render "calendar_sources/sync_status", attempt: latest_attempt %>
    </div>
  </div>
  <div class="flex flex-col items-end gap-2 text-xs">
    <span class="inline-flex items-center gap-1 rounded-full px-2 py-1 <%= sp.active_badge_class %>">
      <span class="h-1.5 w-1.5 rounded-full <%= sp.active_dot_class %>"></span>
      <%= sp.active_label %>
    </span>
    <div class="flex flex-wrap items-center gap-2">
      <%= button_to "Sync", sync_calendar_source_path(source), method: :post, form: { class: "inline", data: { turbo_stream: true } }, class: "rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-200 transition hover:border-slate-500" %>
      <%= button_to "Force Sync", force_sync_calendar_source_path(source), method: :post, form: { class: "inline", data: { turbo_stream: true, controller: "confirm", confirm_message_value: "Force sync for #{source.name} (ignores window)?" } }, class: "rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-200 transition hover:border-slate-500" %>
      <%= button_to "Check Destination", check_destination_calendar_source_path(source), method: :get, form: { class: "inline", data: { turbo: false } }, class: "rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-200 transition hover:border-slate-500" %>
      <%= link_to "Edit", edit_calendar_source_path(source), data: { turbo_frame: "modal" }, class: "rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-200 transition hover:border-slate-500" %>
      <%= button_to(source.active? ? "Pause" : "Resume", toggle_active_calendar_source_path(source), method: :patch, form: { class: "inline", data: { turbo_stream: true } }, class: "rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-200 transition hover:border-slate-500") %>
      <% if source.deleted_at.nil? %>
        <%= button_to t("flashes.calendar_sources.archived"),
              calendar_source_path(source),
              method: :delete,
              form: { class: "inline", data: { controller: "confirm", confirm_message_value: "Archive #{source.name}? You can purge later." } },
              class: "rounded-lg border border-rose-700/70 px-3 py-1 text-xs text-rose-300 transition hover:border-rose-500 hover:text-rose-200" %>
      <% end %>
      <% if source.respond_to?(:deleted_at) && source.deleted_at.present? %>
        <%= button_to "Purge",
              purge_calendar_source_path(source),
              method: :delete,
              form: { class: "inline", data: { controller: "confirm", confirm_message_value: "Permanently delete #{source.name}? This cannot be undone." } },
              class: "rounded-lg border border-rose-800 bg-rose-900/20 px-3 py-1 text-xs text-rose-200 transition hover:border-rose-600" %>
      <% end %>
    </div>
  </div>
</div>
