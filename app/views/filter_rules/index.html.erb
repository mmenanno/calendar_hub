<%= render "shared/page_header",
      nav_active: :filter_rules,
      icon: "ðŸš«",
      title: t("ui.filter_rules.header"),
      subtitle: t("ui.filter_rules.subheader") do %>
  <%= turbo_stream_from "filter_rules" %>

    <div class="space-y-6">
      <%= render "shared/collapsible_section",
            id: "new_filter_rule_form",
            key: "add-filter-rule",
            title: t("ui.filter_rules.add_rule"),
            default_open: (@filter_rules || FilterRule.all).blank? do %>
        <%= render "filter_rules/form", filter_rule: FilterRule.new %>
      <% end %>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="mb-2 text-lg font-semibold"><%= t("ui.filter_rules.test_rules") %></h2>
        <%= form_with url: test_filter_rules_path, method: :post, class: "grid gap-3 md:grid-cols-4", data: { controller: "filter-test", filter_test_url_value: test_filter_rules_path, action: "input->filter-test#queue change->filter-test#queue" } do |f| %>
          <div>
            <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400"><%= t("ui.mappings.source") %></label>
            <div class="select-chevron">
              <%= f.collection_select(:calendar_source_id, CalendarSource.order(:name), :id, :name, { include_blank: "All" }, class: select_class, data: { filter_test_target: "source" }) %>
            </div>
          </div>
          <div>
            <%= f.label(:sample_title, t("ui.mappings.title"), class: "mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400") %>
            <%= f.text_field(:sample_title, placeholder: t("ui.mappings.sample_title"), class: input_class, data: { filter_test_target: "input" }) %>
          </div>
          <div>
            <%= f.label(:sample_description, t("ui.mappings.description"), class: "mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400") %>
            <%= f.text_field(:sample_description, placeholder: t("ui.mappings.sample_description"), class: input_class, data: { filter_test_target: "input" }) %>
          </div>
          <div>
            <%= f.label(:sample_location, t("ui.mappings.location"), class: "mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400") %>
            <%= f.text_field(:sample_location, placeholder: t("ui.mappings.sample_location"), class: input_class, data: { filter_test_target: "input" }) %>
          </div>
          <div id="filter_test_result" class="mt-4"></div>
        <% end %>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-lg font-semibold"><%= t("ui.filter_rules.rules") %></h2>
          <p class="text-sm text-slate-400">
            <%= pluralize((@filter_rules || []).count, t("ui.filter_rules.rule")) %> <%= t("ui.filter_rules.configured") %>
          </p>
        </div>

        <% if (@filter_rules || []).any? %>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-slate-700 text-left">
                <tr class="text-slate-400">
                  <th class="px-3 py-2 w-8"></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.source") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.field") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.match") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.pattern") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.case_sensitive") %></th>
                  <th class="px-3 py-2"><%= t("common.states.active") %></th>
                  <th class="px-3 py-2 pr-6 text-right"></th>
                </tr>
              </thead>
              <tbody id="filter_rules_list" class="divide-y divide-slate-800 text-slate-300" data-controller="sortable" data-sortable-url-value="<%= reorder_filter_rules_path %>" data-sortable-handle-value=".drag-handle">
                <% (@filter_rules || []).each do |filter_rule| %>
                  <%= render "filter_rules/row", filter_rule: filter_rule %>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="py-8 text-center text-slate-400">
            <span class="mb-2 inline-block text-3xl">ðŸš«</span>
            <p class="mb-1"><%= t("ui.filter_rules.no_rules") %></p>
            <p class="text-sm"><%= t("ui.filter_rules.add_first_rule") %></p>
          </div>
        <% end %>
      </div>
    </div>
<% end %>
