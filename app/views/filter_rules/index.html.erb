<div class="min-h-screen bg-slate-950 text-slate-100">
  <header class="bg-slate-900/70 backdrop-blur sticky top-0 z-10 border-b border-slate-800">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-red-500/20 text-red-300">ðŸš«</span>
        <div>
          <h1 class="text-xl font-semibold"><%= t("ui.filter_rules.header") %></h1>
          <p class="text-sm text-slate-400"><%= t("ui.filter_rules.subheader") %></p>
        </div>
      </div>
      <%= render "shared/top_nav", active: :filter_rules %>
    </div>
  </header>

  <section class="mx-auto w-full max-w-6xl px-6 py-8">
    <%= turbo_stream_from "filter_rules" %>
    <%= render "shared/flashes" %>

    <div class="space-y-6">
      <div id="new_filter_rule_form" class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5" data-controller="collapsible" data-collapsible-key-value="add-filter-rule" data-collapsible-default-open-value="<%= (@filter_rules || FilterRule.all).blank? %>" data-collapsible-remember-value="false">
        <div class="mb-3 flex items-center justify-between">
          <h2 class="text-lg font-semibold"><%= t("ui.filter_rules.add_rule") %></h2>
          <button type="button" class="cursor-pointer rounded-lg border border-slate-700 px-3 py-1 text-xs text-slate-200 hover:border-slate-500" data-action="collapsible#toggle">
            <span data-collapsible-target="label"><%= t("ui.common.show") %></span>
            <span data-collapsible-target="icon" class="ml-1 inline-block transition-transform">â–¾</span>
          </button>
        </div>
        <div data-collapsible-target="content" class="hidden">
          <%= render "filter_rules/form", filter_rule: FilterRule.new %>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5">
        <h2 class="mb-2 text-lg font-semibold"><%= t("ui.filter_rules.test_rules") %></h2>
        <%= form_with url: test_filter_rules_path, method: :post, class: "grid gap-3 md:grid-cols-4", data: { controller: "filter-test", filter_test_url_value: test_filter_rules_path, action: "input->filter-test#queue change->filter-test#queue" } do |f| %>
          <div>
            <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400"><%= t("ui.mappings.source") %></label>
            <div class="select-chevron">
              <%= f.collection_select(:calendar_source_id, CalendarSource.order(:name), :id, :name, { include_blank: "All" }, class: select_class, data: { filter_test_target: "source" }) %>
            </div>
          </div>
          <div>
            <%= f.label(:sample_title, t("ui.mappings.title"), class: "mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400") %>
            <%= f.text_field(:sample_title, placeholder: t("ui.mappings.sample_title"), class: input_class, data: { filter_test_target: "input" }) %>
          </div>
          <div>
            <%= f.label(:sample_description, t("ui.mappings.description"), class: "mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400") %>
            <%= f.text_field(:sample_description, placeholder: t("ui.mappings.sample_description"), class: input_class, data: { filter_test_target: "input" }) %>
          </div>
          <div>
            <%= f.label(:sample_location, t("ui.mappings.location"), class: "mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-400") %>
            <%= f.text_field(:sample_location, placeholder: t("ui.mappings.sample_location"), class: input_class, data: { filter_test_target: "input" }) %>
          </div>
          <div id="filter_test_result" class="mt-4"></div>
        <% end %>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-lg font-semibold"><%= t("ui.filter_rules.rules") %></h2>
          <p class="text-sm text-slate-400">
            <%= pluralize((@filter_rules || []).count, t("ui.filter_rules.rule")) %> <%= t("ui.filter_rules.configured") %>
          </p>
        </div>

        <% if (@filter_rules || []).any? %>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-slate-700 text-left">
                <tr class="text-slate-400">
                  <th class="px-3 py-2 w-8"></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.source") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.field") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.match") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.pattern") %></th>
                  <th class="px-3 py-2"><%= t("ui.mappings.case_sensitive") %></th>
                  <th class="px-3 py-2"><%= t("ui.common.active") %></th>
                  <th class="px-3 py-2 pr-6 text-right"></th>
                </tr>
              </thead>
              <tbody id="filter_rules_list" class="divide-y divide-slate-800 text-slate-300" data-controller="sortable" data-sortable-url-value="<%= reorder_filter_rules_path %>" data-sortable-handle-value=".drag-handle">
                <% (@filter_rules || []).each do |filter_rule| %>
                  <%= render "filter_rules/row", filter_rule: filter_rule %>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="py-8 text-center text-slate-400">
            <span class="mb-2 inline-block text-3xl">ðŸš«</span>
            <p class="mb-1"><%= t("ui.filter_rules.no_rules") %></p>
            <p class="text-sm"><%= t("ui.filter_rules.add_first_rule") %></p>
          </div>
        <% end %>
      </div>
    </div>
  </section>
</div>
